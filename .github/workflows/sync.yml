name: Sync Markdown
on: [push]
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 处理Markdown
        run: |
          # 创建必要目录
          mkdir -p my-blog/articles/post
          mkdir -p markdown/_posts

          # 计算起始ID（兼容空目录）
          NEXT_ID=$(( $(ls -1q my-blog/articles/post | wc -l) + 1 ))

          # 处理每篇Markdown
          for MD in markdown/_posts/*.md; do
            [ -e "$MD" ] || continue  # 跳过空目录

            # 生成HTML路径（适配你的/my-blog/结构）
            HTML="my-blog/articles/post/${NEXT_ID}.html"
            
            # 提取标题（兼容Front Matter和普通MD）
            TITLE=$(grep -m1 'title:' "$MD" | cut -d'"' -f2 || basename "$MD" .md | sed 's/^[0-9]\+-//')
            
            # 生成HTML（保持你的原样式）
            echo "<!DOCTYPE html>
            <html>
              <head>
                <title>$TITLE</title>
                <link rel=\"stylesheet\" href=\"/my-blog/static/css/blog.css\">
              </head>
              <body>
                $(pandoc "$MD")
              </body>
            </html>" > "$HTML"

            # 更新articles1.js（绝对路径适配）
            echo "{ title: \"$TITLE\", 
                   link: \"/my-blog/articles/post/${NEXT_ID}.html\", 
                   lastModified: \"$(date +'%Y-%m-%d %H:%M:%S')\" }," >> my-blog/articles/articles1.js

            ((NEXT_ID++))
          done

      - name: 提交更改
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add my-blog/articles/
          git commit -m "自动添加新文章 [skip ci]" || exit 0
          git push